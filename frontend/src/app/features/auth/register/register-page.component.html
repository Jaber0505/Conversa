<section class="section">
  <div class="register">
    <div class="card">

      <!-- Header -->
      <header class="register__header">
        <h1 class="register__title">{{ 'register.title' | t }}</h1>
        <p class="register__subtitle">{{ 'register.subtitle' | t }}</p>
      </header>

      <!-- Progress -->
      <div class="register__progress">
        <div class="register__progress-top">
          <span class="muted">{{ 'register.step' | t }}</span>
          <strong>{{ step }}</strong>
          <span class="muted">/</span>
          <span class="muted">{{ totalSteps }}</span>
        </div>
        <div class="progress">
          <div class="progress__bar" [style.width.%]="progressPercent"></div>
        </div>
      </div>

      <!-- Form -->
      <form [formGroup]="form" (ngSubmit)="onSubmit()" novalidate class="register__form">

        <!-- STEP 1: Identity -->
        <ng-container *ngIf="step === 1">
          <h2 class="h5">{{ 'register.identity.title' | t }}</h2>
          <p class="muted">{{ 'register.identity.help' | t }}</p>

          <div formGroupName="identity" class="grid gap-12 mt-8">
            <div class="form-field">
              <label for="first_name" class="form-label">{{ 'register.first_name' | t }}</label>
              <input
                id="first_name"
                type="text"
                class="input"
                formControlName="first_name"
                [class.input--invalid]="fIdentity.get('first_name')?.invalid && (fIdentity.get('first_name')?.touched || submitted)"
                [attr.placeholder]="'register.first_name.placeholder' | t"
                autocomplete="given-name"
              />
              <div class="field-error" *ngIf="fIdentity.get('first_name')?.errors as e">
                <ng-container *ngIf="e['serverKey']; else firstNameLocalErr">
                  {{ e['serverKey'] | t }}
                </ng-container>
                <ng-template #firstNameLocalErr>
                  <span *ngIf="e['required']">{{ 'common.errors.required' | t }}</span>
                  <span *ngIf="e['maxlength']">{{ 'common.errors.too_long' | t }}</span>
                </ng-template>
              </div>
            </div>

            <div class="form-field">
              <label for="last_name" class="form-label">{{ 'register.last_name' | t }}</label>
              <input
                id="last_name"
                type="text"
                class="input"
                formControlName="last_name"
                [class.input--invalid]="fIdentity.get('last_name')?.invalid && (fIdentity.get('last_name')?.touched || submitted)"
                [attr.placeholder]="'register.last_name.placeholder' | t"
                autocomplete="family-name"
              />
              <div class="field-error" *ngIf="fIdentity.get('last_name')?.errors as e">
                <ng-container *ngIf="e['serverKey']; else lastNameLocalErr">
                  {{ e['serverKey'] | t }}
                </ng-container>
                <ng-template #lastNameLocalErr>
                  <span *ngIf="e['required']">{{ 'common.errors.required' | t }}</span>
                  <span *ngIf="e['maxlength']">{{ 'common.errors.too_long' | t }}</span>
                </ng-template>
              </div>
            </div>

            <div class="form-field">
              <label for="birth_date" class="form-label">{{ 'register.birth_date' | t }}</label>
              <input
                id="birth_date"
                type="date"
                class="input"
                formControlName="birth_date"
                [class.input--invalid]="fIdentity.get('birth_date')?.invalid && (fIdentity.get('birth_date')?.touched || submitted)"
                autocomplete="bday"
              />
              <small class="muted">{{ 'register.birth_date.help' | t }}</small>
              <div class="field-error" *ngIf="fIdentity.get('birth_date')?.errors as e">
                <ng-container *ngIf="e['serverKey']; else birthLocalErr">
                  {{ e['serverKey'] | t }}
                </ng-container>
                <ng-template #birthLocalErr>
                  <span *ngIf="e['required']">{{ 'common.errors.required' | t }}</span>
                  <span *ngIf="e['minAge']">{{ 'register.errors.age_min' | t:{min:18} }}</span>
                </ng-template>
              </div>
            </div>
          </div>

          <div class="register__actions mt-16">
            <button type="button" class="btn" (click)="goNext()">
              {{ 'common.next' | t }}
            </button>
          </div>
        </ng-container>

        <!-- STEP 2: Bio -->
        <ng-container *ngIf="step === 2">
          <h2 class="h5">{{ 'register.bio.title' | t }}</h2>
          <p class="muted">{{ 'register.bio.help' | t }}</p>

          <div formGroupName="bio" class="form-field mt-8">
            <label for="bio" class="form-label">{{ 'register.bio.label' | t }}</label>
            <textarea
              id="bio"
              class="input"
              rows="5"
              formControlName="bio"
              [attr.placeholder]="'register.bio.placeholder' | t"
            ></textarea>
            <div class="field-error" *ngIf="fBio.get('bio')?.errors as e">
              <ng-container *ngIf="e['serverKey']; else bioLocalErr">
                {{ e['serverKey'] | t }}
              </ng-container>
              <ng-template #bioLocalErr>
                <span *ngIf="e['maxlength']">{{ 'common.errors.too_long' | t }}</span>
              </ng-template>
            </div>
          </div>

          <div class="register__actions mt-16">
            <button type="button" class="btn btn--ghost" (click)="goPrev()">
              {{ 'common.back' | t }}
            </button>
            <button type="button" class="btn" (click)="goNext()">
              {{ 'common.next' | t }}
            </button>
          </div>
        </ng-container>

        <!-- STEP 3: Credentials -->
        <ng-container *ngIf="step === 3">
          <h2 class="h5">{{ 'register.credentials.title' | t }}</h2>
          <p class="muted">{{ 'register.credentials.help' | t }}</p>

          <div formGroupName="credentials" class="grid gap-12 mt-8">
            <div class="form-field">
              <label for="email" class="form-label">{{ 'register.email' | t }}</label>
              <input
                id="email"
                type="email"
                class="input"
                formControlName="email"
                [class.input--invalid]="fCred.get('email')?.invalid && (fCred.get('email')?.touched || submitted)"
                [attr.placeholder]="'register.email.placeholder' | t"
                autocomplete="email"
              />
              <div class="field-error" *ngIf="fCred.get('email')?.errors as e">
                <ng-container *ngIf="e['serverKey']; else emailLocalErr">
                  {{ e['serverKey'] | t }}
                </ng-container>
                <ng-template #emailLocalErr>
                  <span *ngIf="e['required']">{{ 'common.errors.required' | t }}</span>
                  <span *ngIf="e['email']">{{ 'common.errors.email' | t }}</span>
                </ng-template>
              </div>
            </div>

            <div class="form-field">
              <label for="password" class="form-label">{{ 'register.password' | t }}</label>
              <input
                id="password"
                type="password"
                class="input"
                formControlName="password"
                [class.input--invalid]="fCred.get('password')?.invalid && (fCred.get('password')?.touched || submitted)"
                [attr.placeholder]="'register.password.placeholder' | t"
                autocomplete="new-password"
              />
              <div class="field-error" *ngIf="fCred.get('password')?.errors as e">
                <ng-container *ngIf="e['serverKey']; else passLocalErr">
                  {{ e['serverKey'] | t }}
                </ng-container>
                <ng-template #passLocalErr>
                  <span *ngIf="e['required']">{{ 'common.errors.required' | t }}</span>
                  <span *ngIf="e['minlength']">{{ 'common.errors.password_length' | t }}</span>
                </ng-template>
              </div>
            </div>

            <div class="form-field mt-4">
              <label class="checkbox">
                <input type="checkbox" formControlName="consent_given" />
                <span>{{ 'register.consent.label' | t }}</span>
              </label>
              <div class="field-error" *ngIf="fCred.get('consent_given')?.errors as e">
                <ng-container *ngIf="e['serverKey']; else consentLocalErr">
                  {{ e['serverKey'] | t }}
                </ng-container>
                <ng-template #consentLocalErr>
                  <span *ngIf="e['required'] || e['requiredTrue']">{{ 'register.errors.consent_required' | t }}</span>
                </ng-template>
              </div>
            </div>
          </div>

          <div class="register__actions mt-16">
            <button type="button" class="btn btn--ghost" (click)="goPrev()">
              {{ 'common.back' | t }}
            </button>
            <button type="button" class="btn" (click)="goNext()">
              {{ 'common.next' | t }}
            </button>
          </div>
        </ng-container>

        <!-- STEP 4: Languages + Submit -->
        <ng-container *ngIf="step === 4">
          <h2 class="h5">{{ 'register.languages.title' | t }}</h2>
          <p class="muted">{{ 'register.languages.help' | t }}</p>

          <div formGroupName="languages" class="grid gap-12 mt-8">
            <div class="form-field">
              <label for="language_native" class="form-label">{{ 'register.native' | t }}</label>
              <select
                id="language_native"
                class="select"
                formControlName="language_native"
                [class.select--invalid]="fLang.get('language_native')?.invalid && (fLang.get('language_native')?.touched || submitted)"
              >
                <option value="" disabled selected>{{ 'register.choose' | t }}</option>
                <option *ngFor="let lang of languages" [value]="lang.code">
                  {{ lang.label }}
                </option>
              </select>
              <div class="field-error" *ngIf="fLang.get('language_native')?.errors as e">
                <ng-container *ngIf="e['serverKey']; else nativeLocalErr">
                  {{ e['serverKey'] | t }}
                </ng-container>
                <ng-template #nativeLocalErr>
                  <span *ngIf="e['required']">{{ 'common.errors.required' | t }}</span>
                </ng-template>
              </div>
            </div>

            <div class="form-field">
              <label class="form-label">{{ 'register.spoken' | t }}</label>
              <div class="chips">
                <label class="chip" *ngFor="let lang of languages">
                  <input
                    type="checkbox"
                    [value]="lang.code"
                    (change)="onToggleLang('languages_spoken', lang.code, $event.target?.checked)"
                    [checked]="(fLang.get('languages_spoken')?.value || []).includes(lang.code)"
                  />
                  <span>{{ lang.label }}</span>
                </label>
              </div>
            </div>

            <div class="form-field">
              <label class="form-label">{{ 'register.wanted' | t }}</label>
              <div class="chips">
                <label class="chip" *ngFor="let lang of languages">
                  <input
                    type="checkbox"
                    [value]="lang.code"
                    (change)="onToggleLang('languages_wanted', lang.code, $event.target?.checked)"
                    [checked]="(fLang.get('languages_wanted')?.value || []).includes(lang.code)"
                  />
                  <span>{{ lang.label }}</span>
                </label>
              </div>
            </div>
          </div>

          <div class="register__actions mt-16">
            <button type="button" class="btn btn--ghost" (click)="goPrev()">
              {{ 'common.back' | t }}
            </button>
            <button type="submit" class="btn" [disabled]="submitting">
              {{ 'register.submit' | t }}
            </button>
          </div>

          <div class="alert alert--error mt-8" *ngIf="globalErrorKey as k">
            {{ k | t }}
          </div>
        </ng-container>

      </form>
    </div>
  </div>
</section>
